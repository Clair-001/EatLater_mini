{"version":3,"file":"InterventionRepository.js","sources":["interfaces/InterventionRepository.js"],"sourcesContent":["import { ImageLibrary } from './ImageLibrary.js';\r\nimport { TextLibrary } from './TextLibrary.js';\r\nimport { InterventionContent } from '../models/InterventionContent.js';\r\n\r\n/**\r\n * 数据仓库接口\r\n * 整合图片库和文案库，提供统一的数据访问接口\r\n */\r\nexport class InterventionRepository {\r\n    constructor() {\r\n        this.imageLibrary = new ImageLibrary();\r\n        this.textLibrary = new TextLibrary();\r\n        this.quickSelectFoods = [];\r\n\r\n        this.initialize();\r\n    }\r\n\r\n    /**\r\n     * 获取干预内容\r\n     * @param {import('../models/FoodInput.js').FoodInput} foodInput - 食物输入对象\r\n     * @returns {Promise<InterventionContent>} 干预内容\r\n     */\r\n    async getInterventionContent(foodInput) {\r\n        try {\r\n            if (!foodInput || !foodInput.isValid()) {\r\n                throw new Error('无效的食物输入');\r\n            }\r\n\r\n            const foodName = foodInput.getCleanName();\r\n            const imageResource = this.imageLibrary.getImageForFood(foodName);\r\n            const guidanceText = this.textLibrary.getRandomGuidanceText();\r\n\r\n            return new InterventionContent(imageResource, guidanceText, foodName);\r\n        } catch (error) {\r\n            console.error('获取干预内容失败:', error);\r\n\r\n            // 返回默认内容\r\n            return new InterventionContent(\r\n                this.imageLibrary.getDefaultImage(),\r\n                this.textLibrary.getDefaultText(),\r\n                foodInput ? foodInput.getCleanName() : '未知食物'\r\n            );\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 获取快捷选择食物列表\r\n     * @returns {Array<string>} 快捷选择食物列表\r\n     */\r\n    getQuickSelectFoods() {\r\n        return [...this.quickSelectFoods];\r\n    }\r\n\r\n    /**\r\n     * 检查食物是否有对应图片\r\n     * @param {string} foodName - 食物名称\r\n     * @returns {boolean} 是否有对应图片\r\n     */\r\n    hasImageForFood(foodName) {\r\n        return this.imageLibrary.isImageAvailable(foodName);\r\n    }\r\n\r\n    /**\r\n     * 获取所有可用的引导文案\r\n     * @returns {Array<string>} 所有引导文案\r\n     */\r\n    getAllGuidanceTexts() {\r\n        return this.textLibrary.getAllGuidanceTexts();\r\n    }\r\n\r\n    /**\r\n     * 添加新的快捷选择食物\r\n     * @param {string} foodName - 食物名称\r\n     */\r\n    addQuickSelectFood(foodName) {\r\n        if (foodName && typeof foodName === 'string' && !this.quickSelectFoods.includes(foodName)) {\r\n            this.quickSelectFoods.push(foodName);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 初始化仓库\r\n     */\r\n    initialize() {\r\n        // 初始化图片库\r\n        this.imageLibrary.initializeDefaultMappings();\r\n\r\n        // 初始化快捷选择食物列表\r\n        this.quickSelectFoods = [\r\n            '披萨',\r\n            '炸鸡',\r\n            '奶茶',\r\n            '蛋糕',\r\n            '薯条'\r\n        ];\r\n    }\r\n\r\n    /**\r\n     * 重置仓库到初始状态\r\n     */\r\n    reset() {\r\n        this.imageLibrary = new ImageLibrary();\r\n        this.textLibrary = new TextLibrary();\r\n        this.quickSelectFoods = [];\r\n        this.initialize();\r\n    }\r\n\r\n    /**\r\n     * 清理缓存数据\r\n     * 清理临时缓存，但保留核心配置\r\n     */\r\n    clearCache() {\r\n        try {\r\n            console.log('清理数据仓库缓存');\r\n\r\n            // 清理图片库缓存\r\n            if (this.imageLibrary && typeof this.imageLibrary.clearCache === 'function') {\r\n                this.imageLibrary.clearCache();\r\n            }\r\n\r\n            // 清理文案库缓存\r\n            if (this.textLibrary && typeof this.textLibrary.clearCache === 'function') {\r\n                this.textLibrary.clearCache();\r\n            }\r\n\r\n            // 清理临时存储的内容缓存\r\n            this.clearTemporaryContentCache();\r\n\r\n            console.log('数据仓库缓存清理完成');\r\n\r\n        } catch (error) {\r\n            console.error('清理数据仓库缓存时发生错误:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 清理临时内容缓存\r\n     */\r\n    clearTemporaryContentCache() {\r\n        try {\r\n            // 清理可能存在的临时内容缓存\r\n            const tempCacheKeys = [\r\n                'lastInterventionContent',\r\n                'recentFoodInputs',\r\n                'imageLoadCache',\r\n                'textSelectionCache'\r\n            ];\r\n\r\n            tempCacheKeys.forEach(key => {\r\n                try {\r\n                    if (typeof uni !== 'undefined' && uni.removeStorageSync) {\r\n                        uni.removeStorageSync(key);\r\n                    }\r\n                } catch (error) {\r\n                    console.warn(`清理内容缓存失败: ${key}`, error);\r\n                }\r\n            });\r\n\r\n        } catch (error) {\r\n            console.error('清理临时内容缓存时发生错误:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 深度清理所有数据\r\n     * 包括配置和缓存\r\n     */\r\n    deepClean() {\r\n        try {\r\n            console.log('深度清理数据仓库');\r\n\r\n            // 清理缓存\r\n            this.clearCache();\r\n\r\n            // 重置到初始状态\r\n            this.reset();\r\n\r\n            console.log('数据仓库深度清理完成');\r\n\r\n        } catch (error) {\r\n            console.error('深度清理数据仓库时发生错误:', error);\r\n        }\r\n    }\r\n}"],"names":["ImageLibrary","TextLibrary","InterventionContent","uni"],"mappings":"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"}